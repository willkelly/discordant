# Deno-First Development Guide

This project follows **100% Deno-first** development practices. This document explains our approach and why you might see some Node/npm artifacts.

## TL;DR

- ✅ All development uses Deno (`deno task dev`, `deno task test`)
- ✅ No `npm install` needed for development
- ✅ `package.json` only exists for Capacitor mobile builds
- ✅ Vite, Svelte, Playwright accessed via `npm:` specifiers in `deno.json`
- ✅ `node_modules/` is auto-generated by Deno and gitignored

## Why "Deno-First"?

**Deno-first** means:
1. Primary development workflow uses Deno exclusively
2. Dependencies managed through `deno.json` import maps
3. npm packages accessed via `npm:` specifiers (Deno's native npm support)
4. No separate Node.js installation or `npm install` step required

## The `package.json` Confusion

### Why does `package.json` exist?

**Answer**: Only for Capacitor mobile builds (iOS/Android).

Capacitor is a mobile app framework that currently requires `package.json`. However:
- **Development** doesn't touch it
- **Testing** doesn't need it
- **Web builds** don't use it
- **Only mobile builds** (`npm run capacitor:ios`, `npm run capacitor:android`) need it

### What's in our `package.json`?

```json
{
  "dependencies": {
    "@capacitor/android": "^6.0.0",
    "@capacitor/core": "^6.0.0",
    "@capacitor/ios": "^6.0.0"
  },
  "devDependencies": {
    "@capacitor/cli": "^6.0.0"
  }
}
```

That's it! Everything else (Vite, Svelte, Playwright, etc.) is accessed via Deno.

## How We Access npm Packages

### The Deno Way: `npm:` Specifiers

Instead of installing packages with `npm install`, Deno can access npm packages directly:

```javascript
// ❌ Old way (requires npm install)
import { DOMParser } from '@xmldom/xmldom';

// ✅ Deno way (no npm install needed)
import { DOMParser } from 'npm:@xmldom/xmldom@^0.8.10';
```

### Import Maps in `deno.json`

For commonly used packages, we add them to the import map:

```json
{
  "imports": {
    "svelte": "npm:svelte@^4.2.18",
    "svelte/store": "npm:svelte@^4.2.18/store",
    "@std/assert": "jsr:@std/assert@^1.0.0"
  }
}
```

Now you can import them cleanly:

```javascript
import { writable } from 'svelte/store';
import { assertEquals } from '@std/assert';
```

### Tasks Use `npm:` Specifiers

```json
{
  "tasks": {
    "dev": "deno run --allow-all npm:vite",
    "build": "deno run --allow-all npm:vite build",
    "test:e2e": "deno run --allow-all npm:playwright test"
  }
}
```

## The `node_modules/` Directory

### Why does it exist?

Deno's `nodeModulesDir: "auto"` setting auto-generates `node_modules/` for npm compatibility. It's:
- ✅ **Auto-generated** by Deno
- ✅ **Gitignored**
- ✅ **Not manually managed**
- ✅ **Not committed to git**

### When is it created?

Deno creates it automatically when you:
- Import from `npm:` packages
- Run tasks that use `npm:` specifiers

## Removed Dependencies

We removed these unnecessary npm dependencies:

| Package | Reason for Removal |
|---------|-------------------|
| **strophe.js** | NOT USED - we have native XMPP implementation |
| **@xmldom/xmldom** | Accessed via `npm:` specifier, not in package.json |
| **svelte** | Accessed via `npm:` specifier |
| **vite** | Accessed via `npm:` specifier |
| **playwright** | Accessed via `npm:` specifier |
| **typescript** | Deno has native TypeScript support |

## Development Workflow

### Daily Development

```bash
# Install Deno dependencies (one-time)
deno install

# Start dev server
deno task dev

# Run tests
deno task test

# Run quality checks
deno task quality
```

**No `npm install` needed!**

### Mobile Development

```bash
# iOS build (requires package.json)
npm install  # Only for Capacitor
npm run capacitor:ios

# Android build
npm install  # Only for Capacitor
npm run capacitor:android
```

## Benefits of This Approach

### 1. Faster Development
- No waiting for `npm install`
- Deno caches dependencies globally
- Smaller project directory (no bloated node_modules for dev)

### 2. Better Security
- Explicit permissions (`--allow-all`, `--allow-net`, etc.)
- No hidden npm postinstall scripts
- Dependency integrity checked by Deno

### 3. Simpler Setup
- One tool: Deno
- No Node.js version management
- No npm/yarn/pnpm confusion

### 4. Modern Standards
- Native ES modules
- Web Standards APIs (WebSocket, DOMParser, Fetch)
- Top-level await
- Built-in TypeScript

## Common Questions

### Q: Why do I see npm packages being downloaded?

**A**: Deno's `npm:` specifier downloads packages on-demand. They're cached globally in `~/.deno/npm/`.

### Q: Should I run `npm install`?

**A**: Only if building for iOS/Android (Capacitor). Never for web development.

### Q: Can I use npm packages?

**A**: Yes! Use `npm:package-name@version` in imports or add to `deno.json` imports.

### Q: Why is `node_modules/` in `.gitignore`?

**A**: It's auto-generated by Deno and should never be committed.

### Q: What about Vite plugins?

**A**: Vite is run via `npm:vite`, plugins work normally. Deno handles the npm compatibility.

## Migration from npm/Node.js

If you're used to Node.js development:

| Node.js | Deno Equivalent |
|---------|-----------------|
| `npm install` | `deno install` (optional) |
| `npm run dev` | `deno task dev` |
| `npm test` | `deno task test` |
| `package.json#dependencies` | `deno.json#imports` |
| `npm:foo` in imports | Same! Deno supports it natively |
| `node index.js` | `deno run index.ts` |

## Resources

- [Deno npm Compatibility](https://docs.deno.com/runtime/fundamentals/node/#using-npm-packages)
- [Import Maps](https://docs.deno.com/runtime/fundamentals/modules/#import-maps)
- [Deno Tasks](https://docs.deno.com/runtime/fundamentals/modules/#deno-task)

## Summary

**This is a Deno project.** The presence of `package.json` and `node_modules/` doesn't mean we use Node.js for development.

- `package.json` = Capacitor mobile builds only
- `node_modules/` = Auto-generated by Deno for npm compat
- All development = 100% Deno

**When in doubt, use `deno task` commands, not `npm` commands.**
